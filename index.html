<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radar semanal Â· Series & PelÃ­culas</title>

  <style>
    :root{
      --bg:#0b0f19; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --panel:#ffffff; --text:#111827; --muted:#6b7280; --border:rgba(0,0,0,.08); --shadow: 0 10px 25px rgba(0,0,0,.08);}
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(52,211,153,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      border-bottom:1px solid var(--border);
    }
    .topbar{display:flex; gap:16px; align-items:flex-start; justify-content:space-between; padding:16px 22px}
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{margin:4px 0 0; color:var(--muted); font-size:13px; line-height:1.3}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      padding:8px 10px; border:1px solid var(--border); border-radius:999px;
      background:rgba(255,255,255,.04);
      font-size:12px; color:var(--muted)
    }

    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; margin-top:18px}
    .card{
      grid-column: span 12;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{padding:16px 16px 10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start}
    .hd h2{margin:0; font-size:15px}
    .hd .meta{color:var(--muted); font-size:12px; margin-top:3px}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      padding:6px 10px; border-radius:999px;
      color:var(--muted); font-size:12px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .list{padding:0 8px 10px}

    .row{
      display:grid;
      grid-template-columns: 36px 1.4fr 160px;
      gap:10px;
      align-items:flex-start;
      padding:12px 10px;
      border-top:1px solid var(--border);
    }
    .rank{
      width:28px; height:28px; border-radius:10px;
      display:grid; place-items:center;
      background:rgba(96,165,250,.12);
      border:1px solid rgba(96,165,250,.22);
      font-weight:800; font-size:12px;
      margin-top:2px;
    }
    .title{display:flex; flex-direction:column; gap:6px}
    .title b{font-size:13px; line-height:1.25}
    .title b a{color:inherit;text-decoration:none}
    .title b a:hover{text-decoration:underline}
    .title span{font-size:12px; color:var(--muted)}

    .platforms, .genres {display:flex; gap:6px; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.cines{border-color:rgba(255,255,255,.18)}
    .badge strong{color:var(--text); font-weight:700}

    .scorepill{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
      padding-top:2px;
    }
    .pillScore{
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      min-width: 92px;
      font-variant-numeric: tabular-nums;
    }
    .submeta{color:var(--muted); font-size:11px; text-align:right}

    .err{
      margin-top:14px;
      border:1px solid rgba(176,0,32,.35);
      background: rgba(176,0,32,.08);
      padding:12px 14px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      display:none;
    }

    /* ===== Destacadas (diseÃ±o anterior) ===== */
    .featured{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
      margin-top:14px;
    }
    .featured h3{margin:0 0 10px; font-size:14px}
    .featuredGrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 900px){ .featuredGrid{grid-template-columns:1fr 1fr;} }
    .featItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
    }
    .featItem .t{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .featItem .t b{font-size:13px}
    .featItem a{color:inherit;text-decoration:none}
    .featItem a:hover{text-decoration:underline}

    /* ===== HistÃ³rico UI ===== */
    .history{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding:14px;
      margin-top:14px;
    }
    .historyTop{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .historyTop h2{
      margin:0;
      font-size:15px;
    }
    .historyTop .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:3px;
    }
    .select{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    select{
      background:rgba(255,255,255,.04);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      outline:none;
    }
    .mini{
      font-size:12px;
      color:var(--muted);
    }

    @media (min-width: 900px){
      .card.half{grid-column: span 6;}
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div>
        <h1>Radar semanal</h1>
        <div class="sub">Top 5 en EspaÃ±a Â· tÃ­tulo FA (si existe) Â· gÃ©neros Â· plataformas/cines Â· links a FA/IMDb</div>
      </div>
      <div class="chips">
        <div class="chip">Ãšltima actualizaciÃ³n: <b id="updatedAt">â€”</b></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="err" class="err"></div>

    <!-- HISTÃ“RICO -->
    <section class="history" id="historyBox">
      <div class="historyTop">
        <div>
          <h2>ðŸ“š HistÃ³rico</h2>
          <div class="hint">Elige una fecha para ver el Top 5 de esa semana (desde <code>data/history</code>).</div>
        </div>
        <div class="select">
          <span class="mini">Fecha:</span>
          <select id="historySelect" disabled>
            <option value="">Cargandoâ€¦</option>
          </select>
          <span class="mini" id="historyStatus">â€”</span>
        </div>
      </div>

      <div class="featured" id="historyFeatured" style="display:none">
        <h3>âœ¨ Destacadas (histÃ³rico)</h3>
        <div class="featuredGrid" id="historyFeaturedGrid"></div>
      </div>

      <div class="grid" style="margin-top:12px">
        <section class="card half">
          <div class="hd">
            <div>
              <h2>ðŸŽ¬ PelÃ­culas Â· Top 5 (histÃ³rico)</h2>
              <div class="meta" id="historyMoviesMeta">â€”</div>
            </div>
            <span class="pill">HistÃ³rico</span>
          </div>
          <div class="list" id="historyMoviesList"></div>
        </section>

        <section class="card half">
          <div class="hd">
            <div>
              <h2>ðŸ“º Series Â· Top 5 (histÃ³rico)</h2>
              <div class="meta" id="historySeriesMeta">â€”</div>
            </div>
            <span class="pill">HistÃ³rico</span>
          </div>
          <div class="list" id="historySeriesList"></div>
        </section>
      </div>
    </section>

    <!-- ACTUAL -->
    <div class="featured" id="featured" style="display:none">
      <h3>âœ¨ Destacadas de la semana</h3>
      <div class="featuredGrid" id="featuredGrid"></div>
    </div>

    <div class="grid">
      <section class="card half">
        <div class="hd">
          <div>
            <h2>ðŸŽ¬ PelÃ­culas Â· Top 5</h2>
            <div class="meta">EspaÃ±a Â· plataformas/cines Â· estreno ES Â· gÃ©nero</div>
          </div>
          <span class="pill">Semana actual</span>
        </div>
        <div class="list" id="moviesList"></div>
      </section>

      <section class="card half">
        <div class="hd">
          <div>
            <h2>ðŸ“º Series Â· Top 5</h2>
            <div class="meta">EspaÃ±a Â· plataformas Â· estreno Â· gÃ©nero</div>
          </div>
          <span class="pill">Semana actual</span>
        </div>
        <div class="list" id="seriesList"></div>
      </section>
    </div>
  </main>

  <script>
    function esc(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function badge(text, cls=""){ return `<span class="badge ${cls}">${esc(text)}</span>`; }

    // Cobertura vÃ¡lida SOLO si existe y num > 0. Acepta "2/6", "1/4"
    function parseCoverageStrict(cov){
      if(cov == null) return null;
      const s = String(cov).trim();
      if(!s || s === "â€”") return null;
      const m = s.match(/^(\d+)\s*\/\s*(\d+)$/);
      if(m){
        const num = Number(m[1]);
        const den = Number(m[2]);
        if(!Number.isFinite(num) || !Number.isFinite(den) || den <= 0) return null;
        return { num, den };
      }
      const n = Number(s);
      if(Number.isFinite(n)) return { num: n, den: null };
      return null;
    }
    function hasValidCoverage(item){
      const c = parseCoverageStrict(item?.coverage);
      return !!c && c.num > 0;
    }

    function finalScore(item){
      return (typeof item?.final === "number") ? item.final : -Infinity;
    }

    function prepareRanking(arr){
      const clean = (Array.isArray(arr) ? arr : [])
        .filter(Boolean)
        .filter(hasValidCoverage);

      clean.sort((a,b) => finalScore(b) - finalScore(a));
      clean.forEach((x,i) => x.rank = i + 1);
      return clean;
    }

    function rowHTML(item){
      const platformsArr = Array.isArray(item.platforms) ? item.platforms.filter(Boolean) : [];
      const platforms = platformsArr.map(p => badge(p)).join("") || badge(item.where || "EspaÃ±a");
      const cines = item.inCinemasES ? badge("Cines", "cines") : "";
      const release = item.releaseES ? badge(`ES: ${item.releaseES}`) : "";

      const genresArr = Array.isArray(item.genres) ? item.genres.slice(0,3) : [];
      const genres = genresArr.length ? genresArr.map(g => badge(g)).join("") : "";

      const href = item.faUrl || item.imdbUrl || null;
      const title = esc(item.title ?? "â€”");
      const titleHTML = href
        ? `<a href="${href}" target="_blank" rel="noopener noreferrer">${title} â†—</a>`
        : title;

      const final = (typeof item.final === "number") ? item.final.toFixed(2) : "â€”";
      const cov = item.coverage ? `Cobertura ${item.coverage}` : "";

      return `
        <div class="row">
          <div class="rank">${item.rank ?? ""}</div>
          <div class="title">
            <b>${titleHTML}</b>
            <div class="platforms">${cines}${platforms}${release}</div>
            ${genres ? `<div class="genres">${genres}</div>` : ``}
          </div>
          <div class="scorepill">
            <div class="pillScore">${final}</div>
            <div class="submeta">${esc(cov)}</div>
          </div>
        </div>
      `;
    }

    function featuredCard(label, x){
      if(!x) return "";
      const href = x.faUrl || x.imdbUrl || "#";
      const p = Array.isArray(x.platforms) && x.platforms.length ? x.platforms.join(" Â· ") : (x.where || "EspaÃ±a");
      const g = Array.isArray(x.genres) && x.genres.length ? x.genres.slice(0,3).join(" / ") : "â€”";
      const c = x.inCinemasES ? "Cines Â· " : "";
      const final = (typeof x.final === "number") ? x.final.toFixed(2) : "â€”";

      return `
        <div class="featItem">
          <div class="t">
            <div>
              <div class="submeta">${esc(label)}</div>
              <b><a href="${href}" target="_blank" rel="noopener noreferrer">${esc(x.title)} â†—</a></b>
              <div class="submeta">${esc(c + p)}${x.releaseES ? " Â· ES: " + esc(x.releaseES) : ""}</div>
              <div class="submeta">GÃ©nero: ${esc(g)}</div>
            </div>
            <div class="pillScore">${final}</div>
          </div>
        </div>
      `;
    }

    // --------- Render helpers ----------
    function renderSection(data, opts){
      const moviesRanked = prepareRanking(data?.movies);
      const seriesRanked = prepareRanking(data?.series);

      const moviesTop = moviesRanked.slice(0, 5);
      const seriesTop = seriesRanked.slice(0, 5);

      document.getElementById(opts.updatedAtId).textContent = data?.updatedAt || "â€”";

      document.getElementById(opts.moviesListId).innerHTML =
        moviesTop.length
          ? moviesTop.map(rowHTML).join("")
          : `<div class="row"><div></div><div class="title"><b>Sin datos</b><span>No hay pelÃ­culas con cobertura</span></div><div></div></div>`;

      document.getElementById(opts.seriesListId).innerHTML =
        seriesTop.length
          ? seriesTop.map(rowHTML).join("")
          : `<div class="row"><div></div><div class="title"><b>Sin datos</b><span>No hay series con cobertura</span></div><div></div></div>`;

      const featuredBox = document.getElementById(opts.featuredBoxId);
      const featuredGrid = document.getElementById(opts.featuredGridId);

      const topMovie = moviesTop[0];
      const topSerie = seriesTop[0];

      if (topMovie || topSerie){
        featuredBox.style.display = "block";
        featuredGrid.innerHTML = [
          featuredCard("ðŸŽ¬ #1 PelÃ­cula", topMovie),
          featuredCard("ðŸ“º #1 Serie", topSerie)
        ].join("");
      } else {
        featuredBox.style.display = "none";
      }

      if(opts.moviesMetaId) document.getElementById(opts.moviesMetaId).textContent = data?.updatedAt ? `Fecha: ${data.updatedAt}` : "â€”";
      if(opts.seriesMetaId) document.getElementById(opts.seriesMetaId).textContent = data?.updatedAt ? `Fecha: ${data.updatedAt}` : "â€”";
    }

    // --------- Load current ----------
    async function loadCurrent(){
      const err = document.getElementById("err");
      try{
        const r = await fetch("./data/latest.json?ts=" + Date.now(), { cache:"no-store" });
        if(!r.ok) throw new Error("No puedo cargar data/latest.json (HTTP " + r.status + ")");
        const data = await r.json();

        renderSection(data, {
          updatedAtId: "updatedAt",
          moviesListId: "moviesList",
          seriesListId: "seriesList",
          featuredBoxId: "featured",
          featuredGridId: "featuredGrid"
        });

      } catch(e){
        err.style.display = "block";
        err.innerHTML = `<b>Error:</b> ${esc(e.message)}<br><span style="color:var(--muted)">Comprueba que existe <code>data/latest.json</code> en GitHub Pages.</span>`;
        document.getElementById("moviesList").innerHTML = "";
        document.getElementById("seriesList").innerHTML = "";
        document.getElementById("featured").style.display = "none";
      }
    }

    // --------- Load history list + selected date ----------
    async function loadHistoryIndex(){
      const sel = document.getElementById("historySelect");
      const status = document.getElementById("historyStatus");
      try{
        const r = await fetch("./data/history/index.json?ts=" + Date.now(), { cache:"no-store" });
        if(!r.ok) throw new Error("No puedo cargar data/history/index.json (HTTP " + r.status + ")");
        const dates = await r.json();
        if(!Array.isArray(dates) || !dates.length) throw new Error("index.json vacÃ­o");

        // MÃ¡s recientes arriba
        const sorted = [...dates].sort().reverse();

        sel.innerHTML = sorted.map(d => `<option value="${esc(d)}">${esc(d)}</option>`).join("");
        sel.disabled = false;

        status.textContent = `${sorted.length} fechas`;

        // autoload mÃ¡s reciente
        await loadHistoryDate(sorted[0]);

        sel.addEventListener("change", async () => {
          if(sel.value) await loadHistoryDate(sel.value);
        });

      } catch(e){
        status.textContent = "HistÃ³rico no disponible";
        sel.disabled = true;
        sel.innerHTML = `<option value="">No disponible</option>`;
        document.getElementById("historyFeatured").style.display = "none";
        document.getElementById("historyMoviesList").innerHTML =
          `<div class="row"><div></div><div class="title"><b>Sin histÃ³rico</b><span>${esc(e.message)}</span></div><div></div></div>`;
        document.getElementById("historySeriesList").innerHTML = "";
      }
    }

    async function loadHistoryDate(date){
      const status = document.getElementById("historyStatus");
      status.textContent = `Cargando ${date}â€¦`;
      try{
        const r = await fetch(`./data/history/${date}.json?ts=` + Date.now(), { cache:"no-store" });
        if(!r.ok) throw new Error(`No puedo cargar data/history/${date}.json (HTTP ${r.status})`);
        const data = await r.json();

        renderSection(data, {
          updatedAtId: "historyStatus",          // aquÃ­ mostramos la fecha cargada
          moviesListId: "historyMoviesList",
          seriesListId: "historySeriesList",
          featuredBoxId: "historyFeatured",
          featuredGridId: "historyFeaturedGrid",
          moviesMetaId: "historyMoviesMeta",
          seriesMetaId: "historySeriesMeta"
        });

        // Ajuste: historyStatus debe mostrar texto humano
        document.getElementById("historyStatus").textContent = `Mostrando ${data?.updatedAt || date}`;

      } catch(e){
        status.textContent = "Error";
        document.getElementById("historyFeatured").style.display = "none";
        document.getElementById("historyMoviesList").innerHTML =
          `<div class="row"><div></div><div class="title"><b>Error histÃ³rico</b><span>${esc(e.message)}</span></div><div></div></div>`;
        document.getElementById("historySeriesList").innerHTML = "";
      }
    }

    loadCurrent();
    loadHistoryIndex();
  </script>
</body>
</html>
