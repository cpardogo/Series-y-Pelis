<section id="filters"></section>
<section id="results"></section>

<script type="module">
  import { passesUIFilters } from "./modules/rules.js";
  import { computeCoverage, coverageBadgeText } from "./modules/coverage.js";
  import { buildFilterOptions, mountFilters, FILTERS_CSS } from "./modules/ui_filters.js";

  const style = document.createElement("style");
  style.textContent = FILTERS_CSS;
  document.head.appendChild(style);

  const DATA_URL = "./data/peliculas.json"; // ðŸ”´ cambia si se llama distinto

  async function loadItems() {
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No puedo cargar " + DATA_URL);
    const data = await res.json();
    return Array.isArray(data) ? data : (data.items || []);
  }

  let items = await loadItems();

  const base = items.map(it => ({ ...it, type: it.type || "movie" }));

  const options = buildFilterOptions(base);
  let currentState = { platformsSelected: [], genresSelected: [] };

  mountFilters(document.querySelector("#filters"), options, (state) => {
    currentState = state;
    render();
  });

  function render() {
    const visible = base
      .filter(it => passesUIFilters(it, currentState))
      .map(it => {
        const cov = computeCoverage(it);
        return { ...it, _cov: cov, _badge: coverageBadgeText(cov.status) };
      });

    document.querySelector("#results").innerHTML = visible.map(it => `
      <article class="card">
        <header class="card__top">
          <h3 class="card__title">${it.title ?? it.name ?? "Sin tÃ­tulo"}</h3>
          <div class="card__badge" title="Falta: ${it._cov.missing.join(", ") || "Nada"}">${it._badge}</div>
        </header>

        <div class="card__meta">
          <span>${(it.platforms || []).join(" Â· ") || "â€”"}</span>
          <span> | </span>
          <span>${(it.genres || []).join(" Â· ") || "â€”"}</span>
        </div>
      </article>
    `).join("");
  }

  render();
</script>
