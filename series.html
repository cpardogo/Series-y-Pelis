<script>
/**
 * MODO REAL (histÃ³rico semanal)
 * Lee:
 *  - ./data/series/index.json        -> { "weeks": ["YYYY-MM-DD", ...] }
 *  - ./data/series/weeks/<week>.json -> { "week":"YYYY-MM-DD", "items":[...], ... }
 */

const IDEAL_WEIGHTS = { fa:0.25, imdb:0.25, rt_crit:0.125, rt_aud:0.125, mc_meta:0.125, mc_user:0.125 };

function to10_rt(x){ return (typeof x==="number") ? (x/10) : null; }
function to10_mcmeta(x){ return (typeof x==="number") ? (x/10) : null; }

// âœ… Permitimos Final con lo disponible (al menos IMDb o FA)
function computeFinal(r){
  if(!r || (typeof r.fa!=="number" && typeof r.imdb_used!=="number" && typeof r.imdb!=="number")) return null;

  const imdbVal =
    (typeof r.imdb_used==="number") ? r.imdb_used :
    (typeof r.imdb==="number") ? r.imdb :
    null;

  const mapped = {
    fa: (typeof r.fa==="number") ? r.fa : null,
    imdb: imdbVal,
    rt_crit: to10_rt(r.rt_crit),
    rt_aud: to10_rt(r.rt_aud),
    mc_meta: to10_mcmeta(r.mc_meta),
    mc_user: (typeof r.mc_user==="number") ? r.mc_user : null
  };

  let wsum = 0;
  const available = [];
  for(const k in IDEAL_WEIGHTS){
    if(mapped[k] !== null && mapped[k] !== undefined){
      wsum += IDEAL_WEIGHTS[k];
      available.push(k);
    }
  }
  if(wsum === 0) return null;

  let total = 0;
  for(const k of available){
    total += (IDEAL_WEIGHTS[k]/wsum) * mapped[k];
  }
  return Math.round(total*100)/100;
}

function coverage(r){
  const fields = ["fa","imdb_used","imdb","rt_crit","rt_aud","mc_meta","mc_user"];
  let have = 0;
  for(const f of fields){ if(r && typeof r[f] === "number") have++; }
  // La demo era /6; aquÃ­ seguimos mostrando /6 para mantener UI (imdb_used o imdb cuentan como 1)
  const imdbPresent = (r && (typeof r.imdb_used==="number" || typeof r.imdb==="number")) ? 1 : 0;
  const faPresent = (r && typeof r.fa==="number") ? 1 : 0;
  const other = ["rt_crit","rt_aud","mc_meta","mc_user"].reduce((acc,k)=> acc + (r && typeof r[k]==="number" ? 1:0), 0);
  const totalHave = faPresent + imdbPresent + other;
  return `${totalHave}/6`;
}

function boolToYes(b){ return b ? "SÃ­" : "No"; }

// ---------- CARGA REAL ----------
let WEEKS = [];                 // ["YYYY-MM-DD", ...] desc
let WEEK_CACHE = new Map();     // week -> items adaptados

async function fetchJSON(url){
  const r = await fetch(url + (url.includes("?") ? "&" : "?") + "ts=" + Date.now(), { cache:"no-store" });
  if(!r.ok) throw new Error(`No puedo cargar ${url} (HTTP ${r.status})`);
  return r.json();
}

function slugId(title){
  return (title || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/(^-|-$)/g,"")
    .slice(0,60) || ("id-" + Math.random().toString(16).slice(2));
}

// Adaptador: item REAL -> estructura demo de series
function adaptItem(real){
  // Si ya viene parecido a demo, devolver
  if(real && real.ratings && real.platforms && real.release_es) return real;

  const title = real.title || real.name || "Sin tÃ­tulo";
  const id = real.id || real.imdbId || slugId(title);

  const season = real.season || real.temporada || "â€”";
  const release_es = real.release_es || real.estreno_es || real.releaseDate || null;

  // platforms: si no sabemos, N/D => false para no mentir
  const platforms = real.platforms || {
    netflix: String(real.netflix || "").toLowerCase() === "sÃ­" || real.netflix === true,
    prime: String(real.prime || "").toLowerCase() === "sÃ­" || real.prime === true,
    disney: String(real.disney || "").toLowerCase() === "sÃ­" || real.disney === true,
    movistar: String(real.movistar || "").toLowerCase() === "sÃ­" || real.movistar === true
  };

  const ratings = real.ratings || {
    fa: (typeof real.fa === "number") ? real.fa : null,
    imdb_used: (typeof real.imdb_used === "number") ? real.imdb_used : null,
    imdb: (typeof real.imdb === "number") ? real.imdb : null,
    rt_crit: (typeof real.rt_c === "number") ? real.rt_c : (typeof real.rt_crit === "number" ? real.rt_crit : null),
    rt_aud:  (typeof real.rt_a === "number") ? real.rt_a : (typeof real.rt_aud === "number" ? real.rt_aud : null),
    mc_meta: (typeof real.mc_m === "number") ? real.mc_m : (typeof real.mc_meta === "number" ? real.mc_meta : null),
    mc_user: (typeof real.mc_u === "number") ? real.mc_u : (typeof real.mc_user === "number" ? real.mc_user : null),
  };

  return {
    id,
    title,
    season,
    release_es,
    country: real.country || real.pais || "N/D",
    language: real.language || real.idioma || "N/D",
    genre: real.genre || real.genero || "N/D",
    platforms,
    ratings
  };
}

async function loadWeeksIndex(){
  const idx = await fetchJSON("./data/series/index.json");
  const weeks = idx.weeks || [];
  if(!Array.isArray(weeks) || weeks.length === 0) throw new Error("index.json no tiene semanas");
  WEEKS = weeks; // desc
}

async function loadWeekItems(week){
  if(WEEK_CACHE.has(week)) return WEEK_CACHE.get(week);
  const wk = await fetchJSON(`./data/series/weeks/${week}.json`);
  const items = (wk.items || []).map(adaptItem);
  WEEK_CACHE.set(week, items);
  return items;
}

async function setWeekOptionsReal(){
  const sel = document.getElementById("weekSelect");
  sel.innerHTML = "";
  WEEKS.forEach((w, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = w;
    sel.appendChild(opt);
  });
  sel.value = "0";
}

// ---------- RENDER ----------
async function render(){
  const idx = parseInt(document.getElementById("weekSelect").value || "0", 10);
  const week = WEEKS[idx];
  const prevWeek = WEEKS[idx+1];
  if(!week) return;

  const currentItems = await loadWeekItems(week);
  const prevItems = prevWeek ? await loadWeekItems(prevWeek) : [];

  const prevMap = new Map(prevItems.map(x => [x.id, computeFinal(x.ratings)]));

  document.getElementById("lastUpdated").textContent = `Semana: ${week}`;

  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  const q = (document.getElementById("q").value || "").toLowerCase().trim();

  const items = currentItems
    .map(x => ({...x, final: computeFinal(x.ratings)}))
    .filter(x => x.final !== null)
    .sort((a,b)=> b.final - a.final)
    .filter(x => !q || (`${x.title} ${x.season}`.toLowerCase().includes(q)));

  items.forEach((x, i) => {
    const pr = prevMap.get(x.id);
    let delta = "";
    if(typeof pr === "number"){
      const d = Math.round((x.final - pr)*100)/100;
      delta = d===0 ? "0" : (d>0 ? `â–² ${d}` : `â–¼ ${Math.abs(d)}`);
    } else if(prevWeek){
      delta = "NEW";
    } else {
      delta = "â€”";
    }
    const deltaClass = delta.startsWith("â–²") ? "up" : delta.startsWith("â–¼") ? "down" : delta==="NEW" ? "new" : "";

    const rt = (typeof x.ratings.rt_crit==="number" && typeof x.ratings.rt_aud==="number")
      ? `${x.ratings.rt_crit}% / ${x.ratings.rt_aud}%` : "N/D";
    const mc = (typeof x.ratings.mc_meta==="number" && typeof x.ratings.mc_user==="number")
      ? `${x.ratings.mc_meta} / ${x.ratings.mc_user}` : "N/D";

    const imdbUsed = (typeof x.ratings.imdb_used==="number") ? x.ratings.imdb_used :
                     (typeof x.ratings.imdb==="number") ? x.ratings.imdb : null;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${i+1}</td>
      <td class="wrap"><b>${x.title}</b> <span class="muted">(${x.season})</span></td>
      <td>${x.release_es ?? "N/D"}</td>
      <td>${x.country ?? "N/D"}</td>
      <td>${x.language ?? "N/D"}</td>
      <td class="wrap">${x.genre ?? "N/D"}</td>
      <td class="center">${boolToYes(!!x.platforms?.netflix)}</td>
      <td class="center">${boolToYes(!!x.platforms?.prime)}</td>
      <td class="center">${boolToYes(!!x.platforms?.disney)}</td>
      <td class="center">${boolToYes(!!x.platforms?.movistar)}</td>
      <td class="right">${typeof x.ratings.fa==="number" ? x.ratings.fa.toFixed(1) : "N/D"}</td>
      <td class="right">${typeof imdbUsed==="number" ? imdbUsed.toFixed(1) : "N/D"}</td>
      <td class="right">${rt}</td>
      <td class="right">${mc}</td>
      <td class="center">${coverage(x.ratings)}</td>
      <td class="right"><b>${x.final.toFixed(2)}</b></td>
      <td class="center ${deltaClass}">${delta}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------- INIT ----------
document.getElementById("q").addEventListener("input", () => render());
document.getElementById("weekSelect").addEventListener("change", () => render());

(async function init(){
  try{
    await loadWeeksIndex();
    await setWeekOptionsReal();
    await render();

    document.title = "Series Â· Radar semanal";
    const h1 = document.querySelector("h1");
    if(h1) h1.textContent = "ðŸ“º Series Â· Radar semanal";

    const note = document.querySelector(".note");
    if(note) note.innerHTML = `<b>IMPORTANTE:</b> datos reales (IMDb hoy). AÃ±adiremos FA/RT/MC progresivamente.`;
  } catch(e){
    const note = document.querySelector(".note");
    if(note) {
      note.innerHTML = `<b>Error cargando datos reales:</b> ${e.message}<br/>Comprueba que existe <code>data/series/index.json</code> y <code>data/series/weeks/&lt;week&gt;.json</code>.`;
    }
    console.error(e);
  }
})();
</script>
