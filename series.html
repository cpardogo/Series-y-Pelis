<!-- === SERIES: filtros + listado === -->
<section id="filters"></section>
<section id="results"></section>

<script type="module">
  import { isInSpainReleaseWindow, passesUIFilters } from "./modules/rules.js";
  import { computeCoverage, coverageBadgeText } from "./modules/coverage.js";
  import { buildFilterOptions, mountFilters, FILTERS_CSS } from "./modules/ui_filters.js";

  // 1) CSS mÃ­nimo para chips (no toca tu CSS global)
  const style = document.createElement("style");
  style.textContent = FILTERS_CSS;
  document.head.appendChild(style);

  // 2) Carga datos de series
  // ðŸ”´ CAMBIA ESTA RUTA si tu JSON se llama distinto
  // Ejemplos tÃ­picos:
  //   ./data/series.json
  //   ./data/radar-series.json
  //   ./data/series-2026-02-26.json
  const DATA_URL = "./data/series.json";

  async function loadItems() {
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No puedo cargar " + DATA_URL);
    const data = await res.json();

    // Ajuste por si el JSON viene como {items:[...]} o directamente [...]
    return Array.isArray(data) ? data : (data.items || []);
  }

  let items = await loadItems();

  // 3) Base = SOLO series estrenadas en EspaÃ±a en Ãºltimos 14 dÃ­as
  //    (si tus items no traen type, fuerza a "series")
  const base = items
    .map(it => ({ ...it, type: it.type || "series" }))
    .filter(it => it.type === "series" && isInSpainReleaseWindow(it, 14));

  // 4) Monta filtros
  const options = buildFilterOptions(base);
  let currentState = { platformsSelected: [], genresSelected: [] };

  mountFilters(document.querySelector("#filters"), options, (state) => {
    currentState = state;
    render();
  });

  // 5) Render
  function render() {
    const visible = base
      .filter(it => passesUIFilters(it, currentState))
      .map(it => {
        const cov = computeCoverage(it);
        return { ...it, _cov: cov, _badge: coverageBadgeText(cov.status) };
      });

    const mount = document.querySelector("#results");
    mount.innerHTML = visible.map(it => `
      <article class="card">
        <header class="card__top">
          <h3 class="card__title">${it.title ?? it.name ?? "Sin tÃ­tulo"}</h3>
          <div class="card__badge" title="Falta: ${it._cov.missing.join(", ") || "Nada"}">${it._badge}</div>
        </header>

        <div class="card__meta">
          <span>${(it.platforms || []).join(" Â· ") || "â€”"}</span>
          <span> | </span>
          <span>${(it.genres || []).join(" Â· ") || "â€”"}</span>
        </div>

        <div class="card__meta">Estreno ES: ${it.releaseDateES || "â€”"}</div>
        <div class="card__meta">
          IMDb: ${(it.imdb && typeof it.imdb.rating === "number") ? it.imdb.rating : "â€”"}
          Â· FA: ${(it.fa && typeof it.fa.rating === "number") ? it.fa.rating : "â€”"}
        </div>
      </article>
    `).join("");
  }

  render();
</script>
